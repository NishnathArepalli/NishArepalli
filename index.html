<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pickup Team Balancer</title>
  <style>
    :root{
      --bg0:#070b16; --bg1:#0b1020;
      --card:rgba(18,26,51,.92);
      --card2:rgba(8,12,25,.55);
      --line:rgba(36,48,90,.65);
      --line2:rgba(36,48,90,.9);
      --text:#e9eeff;
      --muted:rgba(233,238,255,.72);
      --muted2:rgba(233,238,255,.55);
      --brand1:#3b82f6; --brand2:#6366f1;
      --ok:#21c55d; --warn:#f59e0b; --bad:#ef4444;
      --shadow:0 12px 36px rgba(0,0,0,.30);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.25), transparent 55%),
                 radial-gradient(900px 650px at 110% 0%, rgba(59,130,246,.18), transparent 60%),
                 linear-gradient(120deg,var(--bg0),var(--bg1));
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 86px}
    .header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-top:6px}
    .title{font-weight:900;font-size:26px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:14px}
    .chipRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(8,12,25,.45);color:rgba(233,238,255,.85);
      font-size:13px
    }
    .chip b{font-weight:800}
    .linkBtn{
      border:none;background:transparent;color:rgba(233,238,255,.9);
      padding:8px 10px;border-radius:10px;cursor:pointer;
      border:1px solid var(--line);
      background:rgba(8,12,25,.40);
      font-weight:800;font-size:13px
    }
    .linkBtn:active{transform:translateY(1px)}
    .tabs{
      margin-top:14px;
      display:flex;gap:10px;
      padding:10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(8,12,25,.35);
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(8px);
    }
    .tab{
      flex:1;
      border:none;cursor:pointer;
      padding:12px 10px;border-radius:999px;
      font-weight:900;font-size:15px;
      color:rgba(233,238,255,.85);
      background:transparent;
    }
    .tab.active{
      background:linear-gradient(90deg,var(--brand1),var(--brand2));
      color:white;
      box-shadow:0 10px 22px rgba(59,130,246,.22);
    }
    .card{
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    h2{margin:0 0 10px 0;font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:7px}
    input,select,button,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line2);
      background:rgba(8,12,25,.70);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:var(--muted2)}
    select{padding-right:38px}
    button{cursor:pointer;font-weight:900}
    .primary{border:none;background:linear-gradient(90deg,var(--brand1),var(--brand2));color:white}
    .ghost{background:rgba(8,12,25,.35)}
    .danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .row > *{flex:1;min-width:140px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .note{font-size:13px;color:var(--muted);line-height:1.35}
    .error{
      border:1px solid rgba(239,68,68,.45);
      background:rgba(239,68,68,.10);
      border-radius:var(--r);
      padding:12px;
      margin-top:12px;
      display:none;
    }
    .error b{font-weight:900}
    .list{display:flex;flex-direction:column;gap:10px}
    .playerCard{
      display:flex;gap:12px;align-items:flex-start;
      border-radius:14px;border:1px solid var(--line);
      background:rgba(8,12,25,.38);
      padding:12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .playerCard:active{transform:translateY(1px)}
    .playerCard.disabled{opacity:.55; cursor:not-allowed}
    .playerCard.disabled:active{transform:none}

    .cb{
      width:22px;height:22px;border-radius:7px;
      border:1px solid var(--line2);
      background:rgba(8,12,25,.65);
      display:inline-flex;align-items:center;justify-content:center;
      flex:0 0 auto;margin-top:2px;
    }
    .cb.on{background:linear-gradient(90deg,var(--brand1),var(--brand2));border:none}
    .cb svg{width:14px;height:14px;display:none}
    .cb.on svg{display:block}
    .meta{flex:1}
    .name{font-weight:900;font-size:16px}
    .mini{margin-top:3px;font-size:13px;color:rgba(233,238,255,.8)}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{
      font-size:12px;padding:5px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(18,26,51,.55);
      color:rgba(233,238,255,.88)
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btnRow > button{flex:1;min-width:160px}
    .rightBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .rightBtns button{width:auto;min-width:140px}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{flex:1;min-width:180px;border-radius:14px;border:1px solid var(--line);background:rgba(18,26,51,.55);padding:12px}
    .k{font-size:13px;color:var(--muted)}
    .v{font-size:18px;font-weight:900;margin-top:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .teamGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    @media(max-width:760px){ .teamGrid{grid-template-columns:1fr} }
    .teamCard{border-radius:14px;border:1px solid var(--line);background:rgba(8,12,25,.42);padding:12px}
    .teamHeader{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .teamTitle{font-weight:950}
    .score{font-size:13px;color:rgba(233,238,255,.8);text-align:right}
    .playerRow{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px dashed rgba(36,48,90,.55)}
    .playerRow:last-child{border-bottom:none}
    .stickyBar{
      position:fixed;left:0;right:0;bottom:0;z-index:20;
      padding:10px 12px;
      background:linear-gradient(180deg, rgba(7,11,22,0.0), rgba(7,11,22,.85) 22%, rgba(7,11,22,.92));
      backdrop-filter: blur(8px);
    }
    .stickyInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;align-items:center;
    }
    .stickyInner .leftNote{flex:1;color:rgba(233,238,255,.75);font-size:13px}
    .stickyInner button{width:auto;min-width:140px}
    @media(max-width:500px){
      .title{font-size:24px}
      .tab{font-size:14px;padding:11px 8px}
      input,select,button{font-size:16px}
      .stickyInner button{min-width:0;flex:1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">Pickup Team Balancer</div>
        <div class="sub">Join a group → pick who’s playing → generate teams. Built for phone use.</div>
      </div>
      <div class="chipRow">
        <div class="chip" id="groupChip"><span style="opacity:.85">Group:</span> <b id="groupName">None</b></div>
        <button id="changeGroupBtn" class="linkBtn" style="display:none">Change group</button>
      </div>
    </div>

    <div id="errorBox" class="error"><b>Action needed:</b> <span id="errorText"></span></div>

    <div class="tabs" role="tablist" aria-label="Navigation">
      <button class="tab active" id="tabGroup" data-tab="group">Group</button>
      <button class="tab" id="tabPlayers" data-tab="players">Players</button>
      <button class="tab" id="tabTeams" data-tab="teams">Teams</button>
    </div>

    <!-- GROUP -->
    <section id="screen-group" class="card">
      <h2>Group</h2>
      <div class="note">Enter a group code to use the shared roster. Example: <b>SATURDAYRUN</b>. Invite links can auto-fill the code.</div>
      <div class="divider"></div>

      <div class="row">
        <div style="flex:2">
          <label>Group code</label>
          <input id="groupCodeInput" placeholder="e.g., SATURDAYRUN" autocomplete="off" />
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <label style="opacity:.9">Cloud</label>
          <button id="joinBtn" class="primary">Join / Create</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;align-items:center">
        <div class="chip" style="flex:1"><span style="opacity:.8">Status:</span> <b id="statusText">Not connected</b></div>
        <button id="copyInviteBtn" class="ghost" style="width:auto;min-width:180px">Copy invite link</button>
      </div>

      <div class="divider"></div>
      <div class="note">Tip: After you connect once, this device will remember the group and take you straight to Teams next time.</div>
    </section>

    <!-- PLAYERS -->
    <section id="screen-players" class="card" style="display:none">
      <h2>Players</h2>
      <div class="note">Add or edit players in the shared roster.</div>
      <div class="divider"></div>

      <div class="row">
        <div style="flex:1.4">
          <label>Name</label>
          <input id="pName" placeholder="e.g., Nish" />
        </div>
        <div>
          <label>Offense (1–10)</label>
          <select id="pOff"></select>
        </div>
        <div>
          <label>Defense (1–10)</label>
          <select id="pDef"></select>
        </div>
        <div>
          <label>Rebounding (1–10)</label>
          <select id="pReb"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div style="flex:2">
          <label>Notes (optional)</label>
          <input id="pNotes" placeholder="e.g., Big / Shooter / Quick guard" />
        </div>
        <div class="rightBtns">
          <button id="savePlayerBtn" class="primary">Add player</button>
          <button id="cancelEditBtn" class="ghost" style="display:none">Cancel</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="note" id="playersHint">Connect to a group to load players.</div>
      <div id="playerList" class="list" style="margin-top:10px"></div>
    </section>

    <!-- TEAMS -->
    <section id="screen-teams" class="card" style="display:none">
      <h2>Teams</h2>
      <div class="note">Pick who’s playing today, then generate teams.</div>
      <div class="divider"></div>

      <div class="chipRow">
        <div class="chip"><span style="opacity:.8">Selected:</span> <b id="selCount">0</b></div>
        <div class="chip"><span style="opacity:.8">Needed:</span> <b id="needCount">8</b></div>
      </div>


      <div class="divider"></div>
<div class="note" style="margin-top:8px">This format needs <b><span id="needInline">8</span></b> players. Select exactly that many below.</div>


      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:16px">Who’s playing today?</h3>
      <div class="note">Tap players to select them. When you reach the needed count, the rest will be disabled.</div>
      <div id="todayList" class="list" style="margin-top:10px"></div>

      <div class="btnRow" style="margin-top:12px">
        <button id="continueBtn" class="primary">Continue to Generate</button>
        <button id="selectAllBtn" class="ghost">Select all</button>
      </div>

      <div id="genCard" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <h3 style="margin:0 0 8px 0;font-size:16px">Generate teams</h3>

        <div class="row">
          <div>
            <label>Game format</label>
            <select id="gameSize">
              <option value="3">3v3</option>
              <option value="4">4v4</option>
              <option value="5" selected>5v5</option>
            </select>
          </div>
          <div>
            <label># of teams</label>
            <select id="numTeams">
              <option value="2" selected>2 teams</option>
              <option value="3">3 teams (rotate)</option>
              <option value="4">4 teams (rotate)</option>
            </select>
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px">
          <button id="genBtn" class="primary">Generate teams</button>
          <button id="rerollBtn" class="ghost">Re-roll</button>
          <button id="clearSelBtn" class="ghost">Clear selection</button>
        </div>

        <div id="results" style="margin-top:12px"></div>
      </div>
    </section>
  </div>

  <div class="stickyBar">
    <div class="stickyInner">
      <div class="leftNote" id="stickyNote">Connect to a group to begin.</div>
      <button id="stickyAction" class="primary">Go to Group</button>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
(() => {
  // =========================
  //  SUPABASE CONFIG (PASTE)
  // =========================
  const SUPABASE_URL = "https://qkfgnsytldnhenhfqhvr.supabase.co";        // e.g., "https://xxxx.supabase.co"
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZmduc3l0bGRuaGVuaGZxaHZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NTIwOTEsImV4cCI6MjA4NTAyODA5MX0.I9JcTBoZpxT9eTz8dGP_7kXeH0fqu7A_qJ5NK7HknGE";   // anon public key  // anon public key
  const hasSupabase = !!(SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase);

  const supa = hasSupabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

  // =========================
  //  APP STATE
  // =========================
  const LS_GROUP = "pickup_balancer_group_code_v10";
  const LS_GROUP_ID = "pickup_balancer_group_id_v10";

  const els = {
    errorBox: document.getElementById("errorBox"),
    errorText: document.getElementById("errorText"),

    groupName: document.getElementById("groupName"),
    changeGroupBtn: document.getElementById("changeGroupBtn"),

    tabGroup: document.getElementById("tabGroup"),
    tabPlayers: document.getElementById("tabPlayers"),
    tabTeams: document.getElementById("tabTeams"),
    tabs: Array.from(document.querySelectorAll(".tab")),

    screenGroup: document.getElementById("screen-group"),
    screenPlayers: document.getElementById("screen-players"),
    screenTeams: document.getElementById("screen-teams"),

    groupCodeInput: document.getElementById("groupCodeInput"),
    joinBtn: document.getElementById("joinBtn"),
    copyInviteBtn: document.getElementById("copyInviteBtn"),
    statusText: document.getElementById("statusText"),

    // Players
    pName: document.getElementById("pName"),
    pOff: document.getElementById("pOff"),
    pDef: document.getElementById("pDef"),
    pReb: document.getElementById("pReb"),
    pNotes: document.getElementById("pNotes"),
    savePlayerBtn: document.getElementById("savePlayerBtn"),
    cancelEditBtn: document.getElementById("cancelEditBtn"),
    playerList: document.getElementById("playerList"),
    playersHint: document.getElementById("playersHint"),

    // Teams
    selCount: document.getElementById("selCount"),
    needCount: document.getElementById("needCount"),
    needInline: document.getElementById("needInline"),
    todayList: document.getElementById("todayList"),
    continueBtn: document.getElementById("continueBtn"),
    selectAllBtn: document.getElementById("selectAllBtn"),

    genCard: document.getElementById("genCard"),
    gameSize: document.getElementById("gameSize"),
    numTeams: document.getElementById("numTeams"),
    genBtn: document.getElementById("genBtn"),
    rerollBtn: document.getElementById("rerollBtn"),
    clearSelBtn: document.getElementById("clearSelBtn"),
    results: document.getElementById("results"),

    // Sticky
    stickyNote: document.getElementById("stickyNote"),
    stickyAction: document.getElementById("stickyAction"),
  };

  // build 1-10 select options
  const fill10 = (sel, def=6) => {
    sel.innerHTML = "";
    for (let i=1;i<=10;i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = String(i);
      if (i === def) o.selected = true;
      sel.appendChild(o);
    }
  };
  fill10(els.pOff, 6); fill10(els.pDef, 6); fill10(els.pReb, 6);

  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const setError = (msg) => {
    if (!msg) { els.errorBox.style.display="none"; els.errorText.textContent=""; return; }
    els.errorBox.style.display="block"; els.errorText.textContent=msg;
  };

  const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

  // Balancing weights (simple default)
  const W = { offense:0.5, defense:0.25, rebounding:0.25 };
  const overall = (p)=> (p.offense + p.defense + p.rebounding) / 3; // simple average for display/sorting
  const weightedOverall = (p)=> (p.offense*W.offense) + (p.defense*W.defense) + (p.rebounding*W.rebounding);

  const teamTotals = (team) => {
    const t = { offense:0, defense:0, rebounding:0, overall:0 };
    for (const p of team){
      t.offense += p.offense; t.defense += p.defense; t.rebounding += p.rebounding;
      t.overall += weightedOverall(p);
    }
    return t;
  };
  const spread = (arr)=>Math.max(...arr)-Math.min(...arr);
  const objective = (teams) => {
    const totals = teams.map(teamTotals);
    return (spread(totals.map(t=>t.overall))*2.2)
         + (spread(totals.map(t=>t.offense))*0.9)
         + (spread(totals.map(t=>t.defense))*0.9)
         + (spread(totals.map(t=>t.rebounding))*0.6);
  };
  const fairnessLabel = (obj)=>{
    if (obj<=2.5) return {text:"Excellent", cls:"ok"};
    if (obj<=5.5) return {text:"Good", cls:"ok"};
    if (obj<=9) return {text:"Okay", cls:"warn"};
    return {text:"Imbalanced", cls:"bad"};
  };

  const totalNeeded = () => Number(els.gameSize.value) * Number(els.numTeams.value);

  let state = {
    groupCode: "",
    groupId: "",
    players: [],
    selectedToday: new Set(),
    editId: null,
    lastResult: null,
    realtimeSub: null,
  };

  // =========================
  //  NAV / SCREENS
  // =========================
  const showTab = (tabName) => {
    els.tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === tabName));
    els.screenGroup.style.display = tabName === "group" ? "block" : "none";
    els.screenPlayers.style.display = tabName === "players" ? "block" : "none";
    els.screenTeams.style.display = tabName === "teams" ? "block" : "none";

    // sticky action
    if (!state.groupId) {
      els.stickyNote.textContent = "Connect to a group to begin.";
      els.stickyAction.textContent = "Go to Group";
      els.stickyAction.onclick = () => showTab("group");
    } else {
      if (tabName === "teams") {
        els.stickyNote.textContent = "Pick today’s players → Continue → Generate.";
        els.stickyAction.textContent = "Generate";
        els.stickyAction.onclick = () => {
          els.genCard.style.display = "block";
          els.genBtn.scrollIntoView({behavior:"smooth", block:"center"});
        };
      } else if (tabName === "players") {
        els.stickyNote.textContent = "Maintain the roster here.";
        els.stickyAction.textContent = "Add player";
        els.stickyAction.onclick = () => els.pName.focus();
      } else {
        els.stickyNote.textContent = "Connected. You can switch groups anytime.";
        els.stickyAction.textContent = "Go to Teams";
        els.stickyAction.onclick = () => showTab("teams");
      }
    }
  };

  els.tabs.forEach(btn => btn.addEventListener("click", () => showTab(btn.dataset.tab)));

  const setConnectedUI = () => {
    els.groupName.textContent = state.groupCode ? state.groupCode : "None";
    if (state.groupId) {
      els.statusText.textContent = "Connected";
      els.changeGroupBtn.style.display = "inline-flex";
      els.playersHint.textContent = "Roster is shared in the cloud for this group.";
    } else {
      els.statusText.textContent = hasSupabase ? "Not connected" : "Supabase not configured";
      els.changeGroupBtn.style.display = "none";
      els.playersHint.textContent = hasSupabase ? "Connect to a group to load players." : "Paste Supabase keys in the file to enable cloud.";
    }
  };

  const clearGroup = () => {
    localStorage.removeItem(LS_GROUP);
    localStorage.removeItem(LS_GROUP_ID);
    state.groupCode = "";
    state.groupId = "";
    state.players = [];
    state.selectedToday = new Set();
    state.lastResult = null;
    if (state.realtimeSub && supa) {
      supa.removeChannel(state.realtimeSub);
    }
    state.realtimeSub = null;
    setConnectedUI();
    renderPlayers();
    renderTodayList();
    renderResults();
    showTab("group");
    els.groupCodeInput.value = "";
  };

  els.changeGroupBtn.addEventListener("click", clearGroup);

  // =========================
  //  SUPABASE HELPERS
  // =========================
  const ensureSupabase = () => {
    if (!hasSupabase) {
      setError("Supabase keys are missing. Paste SUPABASE_URL and SUPABASE_ANON_KEY in the file, then redeploy.");
      return false;
    }
    return true;
  };

  const normalizeCode = (s) => String(s||"").trim().toUpperCase();

  const getOrCreateGroup = async (code) => {
    code = normalizeCode(code);
    const { data: found, error: e1 } = await supa.from("groups").select("*").eq("code", code).maybeSingle();
    if (e1) throw e1;
    if (found) return found;

    const { data: created, error: e2 } = await supa.from("groups").insert({ code }).select("*").single();
    if (e2) throw e2;
    return created;
  };

  const loadPlayersCloud = async () => {
    if (!state.groupId) return [];
    const { data, error } = await supa
      .from("players")
      .select("*")
      .eq("group_id", state.groupId)
      .order("created_at", { ascending:false });
    if (error) throw error;
    return (data || []).map(x => ({
      id: x.id,
      name: x.name,
      offense: clamp(Number(x.offense||6),1,10),
      defense: clamp(Number(x.defense||6),1,10),
      rebounding: clamp(Number(x.rebounding||6),1,10),
      notes: x.notes || ""
    }));
  };

  const upsertPlayerCloud = async (p) => {
    const payload = {
      group_id: state.groupId,
      name: p.name,
      offense: p.offense,
      defense: p.defense,
      rebounding: p.rebounding,
      notes: p.notes || ""
    };
    if (p.id) {
      const { error } = await supa.from("players").update(payload).eq("id", p.id);
      if (error) throw error;
    } else {
      const { error } = await supa.from("players").insert(payload);
      if (error) throw error;
    }
  };

  const deletePlayerCloud = async (id) => {
    const { error } = await supa.from("players").delete().eq("id", id);
    if (error) throw error;
  };

  const subscribePlayers = () => {
    if (!supa || !state.groupId) return;
    if (state.realtimeSub) supa.removeChannel(state.realtimeSub);
    state.realtimeSub = supa
      .channel("players-" + state.groupId)
      .on("postgres_changes",
        { event:"*", schema:"public", table:"players", filter:`group_id=eq.${state.groupId}` },
        async () => {
          try{
            state.players = await loadPlayersCloud();
            // keep selections that still exist
            const ids = new Set(state.players.map(p=>p.id));
            state.selectedToday = new Set(Array.from(state.selectedToday).filter(id=>ids.has(id)));
            renderPlayers();
            renderTodayList();
          }catch(e){}
        }
      )
      .subscribe();
  };

  // =========================
  //  RENDERERS
  // =========================
  const renderPlayers = () => {
    els.playerList.innerHTML = "";
    if (!state.groupId) return;

    const frag = document.createDocumentFragment();
    const sorted = state.players.slice().sort((a,b)=>overall(b)-overall(a));
    for (const p of sorted){
      const item = document.createElement("div");
      item.className = "playerCard" + (disabled ? " disabled" : "");
      item.style.cursor = "default";

      const meta = document.createElement("div");
      meta.className = "meta";
      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = p.name;

      const mi = document.createElement("div");
      mi.className = "mini";
      mi.textContent = `Overall ${overall(p).toFixed(1)} • O ${p.offense} • D ${p.defense} • R ${p.rebounding}`;

      const tags = document.createElement("div");
      tags.className = "tags";
      if (p.notes){
        const t = document.createElement("span"); t.className="tag"; t.textContent=p.notes; tags.appendChild(t);
      }

      const controls = document.createElement("div");
      controls.className = "btnRow";
      controls.style.marginTop = "10px";

      const edit = document.createElement("button");
      edit.className = "ghost";
      edit.textContent = "Edit";
      edit.addEventListener("click", () => {
        state.editId = p.id;
        els.pName.value = p.name;
        els.pOff.value = String(p.offense);
        els.pDef.value = String(p.defense);
        els.pReb.value = String(p.rebounding);
        els.pNotes.value = p.notes || "";
        els.savePlayerBtn.textContent = "Save changes";
        els.cancelEditBtn.style.display = "inline-block";
        showTab("players");
        els.pName.scrollIntoView({behavior:"smooth", block:"center"});
        els.pName.focus();
      });

      const del = document.createElement("button");
      del.className = "danger";
      del.textContent = "Delete";
      del.addEventListener("click", async () => {
        if (!confirm(`Delete ${p.name}?`)) return;
        try{
          setError("");
          await deletePlayerCloud(p.id);
          // realtime will refresh
        }catch(e){
          setError("Delete failed. Check Supabase policies (RLS) and try again.");
        }
      });

      controls.appendChild(edit);
      controls.appendChild(del);

      meta.appendChild(nm);
      meta.appendChild(mi);
      meta.appendChild(tags);
      meta.appendChild(controls);

      item.appendChild(meta);
      frag.appendChild(item);
    }
    els.playerList.appendChild(frag);
  };

  const renderTodayList = () => {
    els.todayList.innerHTML = "";
    if (!state.groupId) return;

    const frag = document.createDocumentFragment();
    const sorted = state.players.slice().sort((a,b)=>overall(b)-overall(a));
    for (const p of sorted){
      const on = state.selectedToday.has(p.id);
      const need = totalNeeded();
      const disabled = !on && state.selectedToday.size >= need;
      const item = document.createElement("div");
      item.className = "playerCard";
      item.addEventListener("click", () => {
        const need = totalNeeded();
        if (state.selectedToday.has(p.id)) {
          state.selectedToday.delete(p.id);
          setError("");
        } else {
          if (state.selectedToday.size >= need) {
            setError(`This format needs exactly ${need} players. Unselect someone first.`);
            return;
          }
          state.selectedToday.add(p.id);
          setError("");
        }
        refreshCounts();
        // update checkbox state visually
        renderTodayList(); // small list, ok
      });

      const cb = document.createElement("div");
      cb.className = "cb" + (on ? " on" : "");
      cb.innerHTML = `<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.6 6.2L8.6 14.2L3.4 9" stroke="white" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
      const meta = document.createElement("div");
      meta.className = "meta";
      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = p.name;
      const mi = document.createElement("div");
      mi.className = "mini";
      mi.textContent = `O ${p.offense} • D ${p.defense} • R ${p.rebounding}`;
      meta.appendChild(nm); meta.appendChild(mi);

      item.appendChild(cb);
      item.appendChild(meta);
      frag.appendChild(item);
    }
    els.todayList.appendChild(frag);
    refreshCounts();
  };

  const refreshCounts = () => {
    const need = totalNeeded();
    els.selCount.textContent = String(state.selectedToday.size);
    els.needCount.textContent = String(need);
    if (els.needInline) els.needInline.textContent = String(need);
  };

  const renderResults = () => {
    els.results.innerHTML = "";
    const res = state.lastResult;
    if (!res) {
      const div = document.createElement("div");
      div.className = "note";
      div.innerHTML = "After you click <b>Generate teams</b>, results will appear here.";
      els.results.appendChild(div);
      return;
    }

    const label = fairnessLabel(res.objective);
    const kpiRow = document.createElement("div");
    kpiRow.className = "kpiRow";

    const k1 = document.createElement("div");
    k1.className = "kpi";
    k1.innerHTML = `<div class="k">Fairness</div><div class="v ${label.cls}">${label.text}</div>
                    <div class="note" style="margin-top:6px">Balances weighted overall (O/D/R = 50/25/25) and category spreads.</div>`;

    const k2 = document.createElement("div");
    k2.className = "kpi";
    k2.innerHTML = `<div class="k">Players used</div><div class="v">${res.needed}</div>
                    <div class="note" style="margin-top:6px">Uses the exact selected players for this format.</div>`;

    kpiRow.appendChild(k1); kpiRow.appendChild(k2);
    els.results.appendChild(kpiRow);

    const teamGrid = document.createElement("div");
    teamGrid.className = "teamGrid";

    res.teams.forEach((team, idx) => {
      const totals = teamTotals(team);
      const card = document.createElement("div");
      card.className = "teamCard";

      const head = document.createElement("div");
      head.className = "teamHeader";
      head.innerHTML = `<div class="teamTitle">Team ${idx+1}</div>
                        <div class="score">Weighted ${totals.overall.toFixed(1)}<br/>O ${totals.offense} • D ${totals.defense} • R ${totals.rebounding}</div>`;
      card.appendChild(head);

      const list = document.createElement("div");
      list.style.marginTop = "10px";
      for (const p of team){
        const row = document.createElement("div");
        row.className = "playerRow";
        row.innerHTML = `<div><div class="name" style="font-size:15px">${p.name}</div><div class="mini">${p.notes || ""}</div></div>
                         <div class="score">O ${p.offense} / D ${p.defense} / R ${p.rebounding}</div>`;
        list.appendChild(row);
      }
      card.appendChild(list);
      teamGrid.appendChild(card);
    });

    els.results.appendChild(teamGrid);
  };

  // =========================
  //  TEAM GENERATION
  // =========================
  const generateTeams = (iterations = 8000) => {
    setError("");
    const teamSize = Number(els.gameSize.value);
    const numTeams = Number(els.numTeams.value);
    const needed = teamSize * numTeams;

    const selectedPlayers = state.players.filter(p => state.selectedToday.has(p.id));
if (selectedPlayers.length !== needed) {
  if (selectedPlayers.length < needed) {
    setError(`Select ${needed} players for this format. You selected ${selectedPlayers.length}.`);
  } else {
    setError(`Too many selected players. This format needs ${needed}, but you selected ${selectedPlayers.length}.`);
  }
  return null;
}

// Use exactly the selected players, sorted by simple average overall for stability
const roster = selectedPlayers.slice().sort((a,b)=>overall(b)-overall(a));
const base = roster.slice();

    let bestTeams = null;
    let bestObj = Infinity;

    const build = (perm) => {
      const teams = Array.from({length:numTeams}, ()=>[]);
      let t = 0;
      for (const p of perm){
        // round robin fill
        let safety = 0;
        while (teams[t].length >= teamSize && safety < numTeams) { t = (t+1)%numTeams; safety++; }
        teams[t].push(p);
        t = (t+1)%numTeams;
      }
      return teams;
    };

    for (let i=0;i<iterations;i++){
      let perm;
      if (i % 25 === 0) {
        perm = base.slice().sort(()=>Math.random()-0.5);
      } else {
        perm = base.slice();
        const chunk = 4;
        for (let c=0;c<perm.length;c+=chunk){
          const end = Math.min(c+chunk, perm.length);
          const part = perm.slice(c,end).sort(()=>Math.random()-0.5);
          perm.splice(c, end-c, ...part);
        }
      }
      const teams = build(perm);
      const obj = objective(teams);
      if (obj < bestObj) { bestObj = obj; bestTeams = teams; }
    }

    return { teams: bestTeams, objective: bestObj, needed };
  };

  // =========================
  //  EVENTS
  // =========================
  els.copyInviteBtn.addEventListener("click", async () => {
    const code = normalizeCode(els.groupCodeInput.value || state.groupCode || "");
    if (!code) { setError("Enter a group code first."); return; }
    const url = new URL(window.location.href);
    url.searchParams.set("group", code);
    try{
      await navigator.clipboard.writeText(url.toString());
      els.statusText.textContent = "Invite link copied";
      setTimeout(()=>setConnectedUI(), 900);
    } catch {
      setError("Could not copy. Your browser may block clipboard access.");
    }
  });

  els.joinBtn.addEventListener("click", async () => {
    setError("");
    if (!ensureSupabase()) return;

    const code = normalizeCode(els.groupCodeInput.value);
    if (!code) { setError("Group code is required."); return; }

    els.joinBtn.disabled = true;
    els.joinBtn.textContent = "Connecting...";
    try{
      const g = await getOrCreateGroup(code);
      state.groupCode = g.code;
      state.groupId = g.id;

      localStorage.setItem(LS_GROUP, state.groupCode);
      localStorage.setItem(LS_GROUP_ID, state.groupId);

      setConnectedUI();

      state.players = await loadPlayersCloud();
      // start with none selected; user will pick exactly what is needed for today
      state.selectedToday = new Set();
      state.lastResult = null;
      renderPlayers();
      renderTodayList();
      renderResults();
      subscribePlayers();

      // go to Teams by default after connect
      showTab("teams");
      els.genCard.style.display = "none";
      els.statusText.textContent = "Connected";
    } catch(e){
      setError("Join/Create failed. Check Supabase tables (groups, players) and RLS policies.");
    } finally {
      els.joinBtn.disabled = false;
      els.joinBtn.textContent = "Join / Create";
    }
  });

  const clearDraft = () => {
    state.editId = null;
    els.pName.value = "";
    els.pOff.value = "6";
    els.pDef.value = "6";
    els.pReb.value = "6";
    els.pNotes.value = "";
    els.savePlayerBtn.textContent = "Add player";
    els.cancelEditBtn.style.display = "none";
  };

  els.cancelEditBtn.addEventListener("click", () => { clearDraft(); setError(""); });

  els.savePlayerBtn.addEventListener("click", async () => {
    setError("");
    if (!ensureSupabase()) return;
    if (!state.groupId) { setError("Connect to a group first."); showTab("group"); return; }

    const name = String(els.pName.value||"").trim();
    if (!name) { setError("Player name is required."); return; }

    const p = {
      id: state.editId || null,
      name,
      offense: clamp(Number(els.pOff.value||6),1,10),
      defense: clamp(Number(els.pDef.value||6),1,10),
      rebounding: clamp(Number(els.pReb.value||6),1,10),
      notes: String(els.pNotes.value||"").trim()
    };

    els.savePlayerBtn.disabled = true;
    els.savePlayerBtn.textContent = state.editId ? "Saving..." : "Adding...";
    try{
      await upsertPlayerCloud(p);
      clearDraft();
      // realtime refresh should update list; fallback reload:
      state.players = await loadPlayersCloud();
      const ids = new Set(state.players.map(x=>x.id));
      state.selectedToday = new Set(Array.from(state.selectedToday).filter(id=>ids.has(id)));
      renderPlayers();
      renderTodayList();
    } catch(e){
      setError("Save failed. Check Supabase RLS policies and try again.");
    } finally {
      els.savePlayerBtn.disabled = false;
      els.savePlayerBtn.textContent = state.editId ? "Save changes" : "Add player";
    }
  });

  els.selectAllBtn.addEventListener("click", () => {
    state.selectedToday = new Set(state.players.map(p=>p.id));
    renderTodayList();
  });

  els.clearSelBtn.addEventListener("click", () => {
    state.selectedToday = new Set();
    state.lastResult = null;
    renderTodayList();
    renderResults();
    els.genCard.style.display = "none";
  });

  els.continueBtn.addEventListener("click", () => {
    setError("");
    if (!state.groupId) { setError("Connect to a group first."); showTab("group"); return; }
    els.genCard.style.display = "block";
    refreshCounts();
    els.genBtn.scrollIntoView({behavior:"smooth", block:"center"});
  });

  els.gameSize.addEventListener("change", () => { refreshCounts(); state.lastResult=null; renderResults(); });
  els.numTeams.addEventListener("change", () => { refreshCounts(); state.lastResult=null; renderResults(); });

  const doGenerate = () => {
    const res = generateTeams(9000);
    if (!res) return;
    state.lastResult = res;
    renderResults();
  };

  els.genBtn.addEventListener("click", doGenerate);
  els.rerollBtn.addEventListener("click", doGenerate);

  // =========================
  //  BOOTSTRAP (AUTO JOIN)
  // =========================
  const bootstrap = async () => {
    setError("");
    setConnectedUI();

    // auto-fill group from invite link ?group=
    const url = new URL(window.location.href);
    const qGroup = normalizeCode(url.searchParams.get("group") || "");
    if (qGroup) els.groupCodeInput.value = qGroup;

    const cachedCode = normalizeCode(localStorage.getItem(LS_GROUP) || "");
    const cachedId = localStorage.getItem(LS_GROUP_ID) || "";

    // If we have cached group and supabase configured, auto-join and go to Teams
    if (cachedCode && cachedId && hasSupabase) {
      state.groupCode = cachedCode;
      state.groupId = cachedId;
      setConnectedUI();
      els.statusText.textContent = "Connecting...";
      try{
        state.players = await loadPlayersCloud();
        state.selectedToday = new Set();
        renderPlayers();
        renderTodayList();
        renderResults();
        subscribePlayers();
        showTab("teams");
      } catch(e){
        // fall back to Group screen if cache invalid
        clearGroup();
      }
    } else {
      // default: if invite group exists, show Group screen
      showTab("group");
    }
  };

  bootstrap();
})();
</script>
</body>
</html>
